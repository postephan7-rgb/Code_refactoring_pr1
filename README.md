# Code_refactoring_pr1

## Рефакторинг программного кода
### Отчет по практике №1

1. Непонятное название переменных и функций

Влияние:

 Создает проблемы с читаемостью кода
 Затрудняет поддержку и отладку
 Увеличивает время разработки
 Приводит к неправильному пониманию логики (особенно при работе с `Dictionary<string, object>` и неочевидными ключами)

В исходном варианте большая часть данных (товар, пользователь, заказ) хранилась в виде словарей с ключами `"id"`, `"email"`, `"phone"`, `"stock"` и т.д. Также использовались неочевидные имена методов, например `DoStuff` для отправки SMS.

Решение: `Rename` – улучшить именование

 Ввести отдельные модели `Product`, `User`, `OrderItem`, `Order` с понятными свойствами.
 Переименовать метод `DoStuff` в `SendOrderConfirmation`.
 Использовать осмысленные имена переменных и свойств: `OrderService`, `InventoryService`, `NotificationService`, `OrderStatus` и т.д.

---

2. Дублирование кода

Влияние:

 Затрудняет поддержку и отладку кода
 Повышенный риск ошибок
 Снижение читаемости кода
 Рост объема кода
 Сложность масштабирования

В исходном коде повторялись:

 Поиск товара в инвентаре по идентификатору
 Логика проверки остатков и их изменения
 Формирование сообщений для уведомлений

Решение: `Extract Method` – вынос дублирующего кода в отдельные функции

 Вынесен поиск и работа с товарами в `InventoryService`.
 Созданы отдельные методы для отправки уведомлений в `EmailSender` и `SmsSender`.
 Общая логика уведомлений вынесена в `NotificationService`.

---

3. Слишком длинный метод или функции, выполняющие несколько задач

Влияние:

 Затрудняет поддержку и отладку кода
 Снижение читаемости кода
 Появляется дублирование кода
 Проблемы с расширением функционала

Метод `PlaceOrder` в старой версии выполнял сразу всё: проверку наличия товара, обновление остатков, создание заказа, отправку email и SMS, логирование.

Решение: `Split Method` – разделить метод на два и более

 Логика разнесена по методам `ValidateItemsAvailability`, `UpdateInventory`, `PlaceOrder`, `LogOrderPlaced`.
 В классе `OrderService` метод `PlaceOrder` стал более коротким и выполняет роль «оркестратора».

---

4. Неверная распределенность ответственности / нарушение SRP

Влияние:

 Затрудняет поддержку и отладку
 Потенциальное появление ошибок
 Снижение читаемости
 Сложность тестирования
 Увеличение связанности

Ранее класс `Order`:

 Хранил данные о заказе
 Управлял глобальным инвентарем
 Работал с «БД»
 Отправлял email и SMS
 Писал логи

Решение: `Extract Class`

 Введены отдельные классы:
   `InventoryService` – управление товарами и остатками.
   `InMemoryDatabase` – сохранение заказов.
   `OrderService` – бизнес-логика оформления заказа.
   `EmailSender` и `SmsSender` – отправка уведомлений.
   `NotificationService` – единая точка для уведомлений.
 Класс `Order` стал моделью данных заказа.

---

5. Сложная вложенная логика

Влияние:

 Затрудняет расширение
 Ухудшает читаемость
 Увеличивает количество ветвлений

В исходном коде логика оформления заказа была «смешана» в одном месте, с проверками наличия товара и условной отправкой SMS по `User["phone"]`.

Решение: `Decompose Conditional`

 Проверка возможности отправки уведомлений вынесена в `NotificationService`.
 Работа с остатками и проверками вынесена в отдельные методы `EnsureInStock` и `DecreaseStock` внутри `InventoryService`.
 В результате условная логика стала более прозрачной и распределенной по специализированным классам.

---

6. Магические числа

Влияние:

 Ухудшает читаемость
 Затрудняет поддержку и отладку
 Замедляет процесс разработки
 Увеличивает риск появления ошибок

В исходном варианте напрямую использовались значения:

 Начальный остаток товара (`stock = 10`, `stock = 5`)
 Количество заказываемого товара (`quantity = 2`)
 Цена (`999.99m`)

Решение: `Replace Magic Number with Symbolic Constant`

 Числа вынесены в параметры моделей (`Product.Stock`, `Product.Price`) и могут быть заданы в одном месте.
 При необходимости их можно оформить как константы или вынести в конфигурацию приложения.

---

7. Отсутствие обработки исключений/ошибок

Влияние:

 Некорректная работа приложения
 Неочевидное поведение при ошибках
 Сложность поиска причин сбоев

Ранее использовался общий `Exception` при нехватке товара, без четкого разделения типов ошибок.

Решение: `Introduce Special Case`

 Добавлен собственный тип исключения `OutOfStockException`.
 `InventoryService.EnsureInStock` бросает `OutOfStockException` при отсутствии товара или недостаточном остатке.
 В `Program.Main` ошибки обработки заказов разделены: отдельно выводятся сообщения для нехватки товара и для прочих исключений.

---

8. Магические строки

Влияние:

 Ухудшает читаемость
 Затрудняет поддержку и отладку
 Замедляет процесс разработки
 Увеличивает риск появления ошибок (опечатки в ключах и строках сообщений)

В исходном коде использовались магические строки:

 Статус заказа `"pending"`
 Названия полей словарей `"id"`, `"items"`, `"userId"`, `"email"`, `"phone"`, `"stock"` и др.
 Тексты сообщений для email и SMS

Решение: `Replace Magic Literal with Named Constant`

 Вместо строкового статуса используется перечисление `OrderStatus` (`Pending`, `Completed`, `Cancelled`).
 Данные представлены свойствами моделей (`User.Email`, `User.Phone`, `Product.Id`, `Product.Stock`), а не ключами словаря.
 Формирование текстов сообщений вынесено в классы `EmailSender` и `SmsSender`.

---

#### Этапы рефакторинга

 Этап 1: Изменение именования переменных/констант и отказ от `Dictionary<string, object>` в пользу моделей.
 Этап 2: Избавление от магических чисел/строк, использование свойств и enum.
 Этап 3: Уменьшение вложенности и сложности логики оформления заказа.
 Этап 4: Разделение методов на более мелкие (`ValidateItemsAvailability`, `UpdateInventory`, `LogOrderPlaced` и др.).
 Этап 5: Разделение ответственности по файлам/классам (`OrderService`, `InventoryService`, `NotificationService`, `InMemoryDatabase` и т.д.).

Начальное кол-во строк:  ~140  
Финальное кол-во строк: ~415  

---

### Результат работы программы

#### До рефакторинга:

```text
Sending email to: user@example.com
Sending SMS to 123-456-7890: Your order 6615afa2-03a4-4a77-86e5-39c0dbeacd37 is placed.
Order placed: 6615afa2-03a4-4a77-86e5-39c0dbeacd37
Order created: 6615afa2-03a4-4a77-86e5-39c0dbeacd37
Product created: Laptop
```

#### После рефакторинга:

```text
Sending email to: user@example.com
Subject: Your order is placed!
Text: Your order eb05e282-8513-4f0e-9db9-6e9a349e5777 has been placed.
Sending SMS to 123-456-7890: Your order eb05e282-8513-4f0e-9db9-6e9a349e5777 is placed.
Order placed: eb05e282-8513-4f0e-9db9-6e9a349e5777
Order created: eb05e282-8513-4f0e-9db9-6e9a349e5777
Product created: Laptop
```


## Тестирование методов


### Метод `PlaceOrder`

| Сценарий                     | Входные данные                                                                 | Ожидаемый результат                                                                                          | Статус   |
|------------------------------|---------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------|----------|
| Успешное оформление заказа   | Пользователь с email и телефоном, товар `prod1` c `stock = 10`, заказ `quantity = 2` | Создается заказ, остаток товара уменьшается до `8`, отправляются email и SMS                                 | Пройдено |
| Недостаточный остаток товара | Товар `prod1` c `stock = 1`, заказ `quantity = 5`                              | Бросается исключение `OutOfStockException`, заказ не создается                                                | Пройдено |
| Пользователь без телефона    | Пользователь только с email, товар доступен                                   | Отправляется только email-уведомление, SMS не отправляется, заказ создается успешно                          | Пройдено |
| Несуществующий товар         | В заказе товар с несуществующим `Id`                                          | Бросается `OutOfStockException` с сообщением о том, что товар не найден                                       | Пройдено |

---

### Метод `CreateProduct`

| Сценарий           | Входные данные                                                                                                                                       | Ожидаемый результат                                                                                                          | Статус   |
|--------------------|------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------|----------|
| Корректный продукт | `name = "Laptop"`, `description = "Gaming laptop"`, `price = 999.99m`, `category = "Electronics"`, `stock = 5`, `supplier = "TechSupplier"`, `tags = ["gaming","laptop","electronics"]`, `isActive = true` | Создается объект `Product` с заданными полями, в консоль выводится строка `Product created: Laptop`                         | Пройдено |
| Нулевой остаток    | Те же параметры, но `stock = 0`                                                                                                                     | Создается продукт с нулевым остатком, допускается как валидный кейс (например, для предзаказов)                             | Пройдено |
| Отрицательный запас| Те же параметры, но `stock = -1`                                                                                                                    | В текущей реализации продукт создается; в расширенной версии можно добавить валидацию и исключение                           | Пройдено |
